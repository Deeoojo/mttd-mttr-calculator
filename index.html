<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TTD / TTR Calculator</title>
  <style>
    :root{
      --blue:#1e6fff;
      --blue2:#0b5fff;
      --bg:#f5f9ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#dbeafe;
      --bad:#b00020;
      --ok:#0a7a3b;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(30,111,255,.20), transparent 55%),
        radial-gradient(900px 500px at 95% 0%, rgba(30,111,255,.12), transparent 60%),
        var(--bg);
    }
    .wrap{ max-width: 1150px; margin: 28px auto 90px; padding: 0 18px; }

    header{
      display:flex; gap:16px; align-items:flex-start; justify-content:space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .title{
      background: linear-gradient(135deg, rgba(30,111,255,.10), rgba(30,111,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px 18px;
      box-shadow: var(--shadow);
      flex:1;
      min-width: 300px;
    }
    h1{ margin: 0 0 2px; font-size: 22px; letter-spacing: .2px; }
    .subtitle{ margin:0; min-height: 18px; }

    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
      min-width: 280px;
    }
    button{
      border: 1px solid rgba(2,6,23,.10);
      border-radius: 14px;
      padding: 10px 12px;
      background: var(--card);
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(2,6,23,.06);
      font-weight: 800;
    }
    button:hover{ transform: translateY(-1px); }
    button:active{ transform: translateY(0); }
    button:disabled{ opacity:.5; cursor:not-allowed; transform:none; }
    .primary{
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      color: white;
      border-color: rgba(255,255,255,.0);
    }
    .ghost{
      background: rgba(255,255,255,.65);
      backdrop-filter: blur(8px);
    }
    .danger{
      background: rgba(255,255,255,.75);
      border-color: rgba(176,0,32,.22);
    }
    .danger:hover{ border-color: rgba(176,0,32,.45); }

    .toggle{
      display:flex; gap:8px; align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(2,6,23,.10);
      background: rgba(255,255,255,.65);
      backdrop-filter: blur(8px);
      box-shadow: 0 6px 16px rgba(2,6,23,.06);
      color: var(--muted);
      font-size: 13px;
      font-weight: 800;
      user-select: none;
    }
    .toggle input{ transform: translateY(1px); }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .controls{ justify-content:flex-start; }
    }

    .panel{
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(10px);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(219,234,254,.9);
      background: linear-gradient(135deg, rgba(30,111,255,.10), rgba(30,111,255,.03));
    }
    .panel .hd .left{ display:flex; flex-direction:column; gap:2px; }
    .panel .hd .ttl{ font-weight: 950; }
    .panel .hd .sub{ color: var(--muted); font-size: 12.5px; font-weight: 700; }
    #status { font-weight: 900; }

    /* ---- Event cards (horizontal stage rows) ---- */
    .eventContainer{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .eventCard{
      background: rgba(255,255,255,.86);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: 0 10px 22px rgba(2,6,23,.06);
      display:flex;
      flex-direction:column;
      gap:14px;
      position: relative;
      overflow:hidden;
    }
    .eventCard::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 6px;
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      opacity: .85;
    }
    .eventHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding-left: 6px;
    }
    .eventTitle{
      flex:1;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(2,6,23,.12);
      font-weight: 900;
      background: rgba(255,255,255,.92);
    }

    .stageRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      padding-left: 6px;
    }
    .stageLabel{
      font-weight: 900;
      color: var(--muted);
      min-width: 230px;
    }

    .timeCell{
      display:flex;
      gap: 6px;
      align-items:center;
      flex-wrap: nowrap;
    }
    .timeCell input{
      width: 70px;
      text-align:center;
      padding: 10px 8px;
      border-radius: 14px;
      border: 1px solid rgba(2,6,23,.12);
      background: rgba(255,255,255,.92);
      font-weight: 900;
      font-variant-numeric: tabular-nums;
    }
    .timeCell input:focus{
      outline: 3px solid rgba(30,111,255,.18);
      border-color: rgba(30,111,255,.35);
    }
    .sep{ color: rgba(71,85,105,.6); font-weight: 900; padding: 0 2px; }

    .removeBtn{
      padding: 9px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.92);
      font-weight: 900;
    }

    .cards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 520px){
      .cards{ grid-template-columns: 1fr; }
    }
    .card{
      background: rgba(255,255,255,.82);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px 14px;
      box-shadow: 0 10px 22px rgba(2,6,23,.06);
      min-height: 92px;
    }
    .card .k{ color: var(--muted); font-size: 12.5px; font-weight: 900; }
    .card .v{ margin-top: 6px; font-size: 18px; font-weight: 950; }
    .card .h{ margin-top: 6px; color: var(--muted); font-size: 12.5px; font-weight: 700; }

    .outBox{
      padding: 12px 14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      color: var(--text);
    }
    .outEmpty{ color: rgba(71,85,105,.75); }
    .bad{ color: var(--bad); font-weight: 950; }
    .ok{ color: var(--ok); font-weight: 950; }

    .footerDock{
      position: fixed;
      right: 18px;
      bottom: 18px;
      display:flex;
      gap: 10px;
      align-items:center;
      z-index: 10;
    }
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(15,23,42,.92);
      color: white;
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
      box-shadow: 0 10px 30px rgba(2,6,23,.25);
      display:none;
      z-index: 11;
      font-weight: 800;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>TTD / TTR Calculator</h1>
        <p class="subtitle"></p>
      </div>

      <div class="controls">
        <button id="addRow" class="ghost">+ Add event</button>
        <button id="clear" class="danger">Clear</button>
        <button id="copy" class="ghost">Copy results</button>
        <label class="toggle" title="If a later time is earlier (e.g., 23:59 → 00:10), treat it as next day">
          <input type="checkbox" id="midnight" checked />
          Midnight rollover
        </label>
      </div>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="hd">
          <div class="left">
            <div class="ttl">Events</div>
            <div class="sub">Paste HH:MM or HH:MM:SS into any time box</div>
          </div>
          <div class="sub" id="status"></div>
        </div>

        <div id="tbl" class="eventContainer"></div>
      </section>

      <aside class="panel">
        <div class="hd">
          <div class="left">
            <div class="ttl">Summary</div>
            <div class="sub" id="summarySub">Run Calculate</div>
          </div>
        </div>

        <div class="cards" id="summary"></div>

        <div class="hd" style="border-top:1px solid rgba(219,234,254,.9); border-bottom:none;">
          <div class="left">
            <div class="ttl">Per-event output</div>
            <div class="sub"></div>
          </div>
        </div>
        <div id="output" class="outBox outEmpty">Run Calculate to see results.</div>
      </aside>
    </div>
  </div>

  <div class="footerDock">
    <button id="calc" class="primary">Calculate</button>
  </div>

  <div id="toast" class="toast"></div>

<script>
(() => {
  "use strict";

  const $ = (id) => document.getElementById(id);

  function clampInt(v) {
    const n = parseInt(String(v ?? "").trim(), 10);
    return Number.isFinite(n) && n >= 0 ? n : 0;
  }
  function pad2(n){ return String(clampInt(n)).padStart(2, "0"); }

  // >= 1 hour: "H hours M minutes S seconds", else: "M minutes S seconds"
  function formatHMS(totalSeconds) {
    const s0 = Math.max(0, Math.round(totalSeconds));
    const hours = Math.floor(s0 / 3600);
    const rem = s0 % 3600;
    const minutes = Math.floor(rem / 60);
    const seconds = rem % 60;
    if (hours > 0) return `${hours} hour${hours === 1 ? "" : "s"} ${minutes} minutes ${seconds} seconds`;
    return `${minutes} minutes ${seconds} seconds`;
  }

  // Robust: find any HH:MM or HH:MM:SS in the pasted text, prefer the rightmost valid clock-time.
  function parseClockToHMS(text) {
    const t = String(text || "").trim();
    if (!t) return null;

    const matches = [...t.matchAll(/\b(\d{1,2}):(\d{2})(?::(\d{2}))?\b/g)];
    if (!matches.length) return null;

    for (let i = matches.length - 1; i >= 0; i--) {
      const m = matches[i];
      const hh = parseInt(m[1], 10);
      const mm = parseInt(m[2], 10);
      const ss = m[3] != null ? parseInt(m[3], 10) : 0;

      if (!Number.isFinite(hh) || !Number.isFinite(mm) || !Number.isFinite(ss)) continue;
      if (mm > 59 || ss > 59) continue;

      // 3-part -> HH:MM:SS
      if (m[3] != null) {
        if (hh > 23) continue;
        return { h: hh, m: mm, s: ss };
      }

      // 2-part -> HH:MM only if hh <= 23 (prevents MM:SS from being treated as clock-time)
      if (hh <= 23) return { h: hh, m: mm, s: 0 };
    }

    return null;
  }

  function hmsToSec(h, m, s) {
    return clampInt(h) * 3600 + clampInt(m) * 60 + clampInt(s);
  }

  function diffClockSeconds(startSec, endSec, midnightHandling) {
    if (endSec >= startSec) return endSec - startSec;
    return midnightHandling ? (endSec + 86400) - startSec : NaN;
  }

  function mean(arr) {
    const xs = arr.filter(x => Number.isFinite(x));
    if (!xs.length) return null;
    return xs.reduce((a,b)=>a+b,0) / xs.length;
  }

  function isAllZero(t){ return (t.h|0)===0 && (t.m|0)===0 && (t.s|0)===0; }

  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> el.style.display="none", 1600);
  }

  const STAGES = [
    { key: "created",  label: "System created alert time" },
    { key: "detected", label: "Detection time" },
    { key: "response", label: "Response time" },
  ];

  function newEvent(name) {
    return { name, t: {
      created:{h:0,m:0,s:0},
      detected:{h:0,m:0,s:0},
      response:{h:0,m:0,s:0}
    }};
  }

  let events = [ newEvent("Event 1") ];

  function makeNumericInput(initial, placeholder, max, onCommit, onPasteClock) {
    const inp = document.createElement("input");
    inp.placeholder = placeholder;
    inp.value = pad2(initial);
    inp.inputMode = "numeric";
    inp.autocomplete = "off";
    inp.spellcheck = false;

    // Hard strip non-digits as you type
    inp.addEventListener("input", () => {
      const digits = inp.value.replace(/[^\d]/g, "");
      inp.value = digits;
      const n = digits === "" ? 0 : clampInt(digits);
      onCommit(Math.min(max, n));
    });

    // Pad on blur (so it doesn't fight typing)
    inp.addEventListener("blur", () => {
      const digits = inp.value.replace(/[^\d]/g, "");
      const n = digits === "" ? 0 : clampInt(digits);
      const v = Math.min(max, n);
      onCommit(v);
      inp.value = pad2(v);
    });

    // Paste: if it's a clock string, fill full HH/MM/SS
    inp.addEventListener("paste", (e) => {
      const pasted = (e.clipboardData || window.clipboardData).getData("text");
      const parsed = parseClockToHMS(pasted);
      if (!parsed) return; // allow default paste; input handler will strip to digits
      e.preventDefault();
      onPasteClock(parsed);
    });

    return inp;
  }

  // ✅ FIXED: don't re-render during paste; directly set the three boxes and update the model.
  function makeTimeCell(ev, stageKey) {
    const wrap = document.createElement("div");
    wrap.className = "timeCell";
    const v = ev.t[stageKey];

    const h = makeNumericInput(v.h, "HH", 23,
      (val) => { ev.t[stageKey].h = val; },
      (parsed) => applyParsed(parsed)
    );
    const m = makeNumericInput(v.m, "MM", 59,
      (val) => { ev.t[stageKey].m = val; },
      (parsed) => applyParsed(parsed)
    );
    const s = makeNumericInput(v.s, "SS", 59,
      (val) => { ev.t[stageKey].s = val; },
      (parsed) => applyParsed(parsed)
    );

    function applyParsed(parsed) {
      // mutate (don’t replace) + update UI directly
      ev.t[stageKey].h = parsed.h;
      ev.t[stageKey].m = parsed.m;
      ev.t[stageKey].s = parsed.s;

      h.value = pad2(parsed.h);
      m.value = pad2(parsed.m);
      s.value = pad2(parsed.s);
    }

    wrap.appendChild(h);
    wrap.appendChild(Object.assign(document.createElement("span"), {className:"sep", textContent:":"}));
    wrap.appendChild(m);
    wrap.appendChild(Object.assign(document.createElement("span"), {className:"sep", textContent:":"}));
    wrap.appendChild(s);

    return wrap;
  }

  function render() {
    const container = $("tbl");
    container.innerHTML = "";

    events.forEach((ev, idx) => {
      const card = document.createElement("div");
      card.className = "eventCard";

      const header = document.createElement("div");
      header.className = "eventHeader";

      const nameInput = document.createElement("input");
      nameInput.className = "eventTitle";
      nameInput.value = ev.name || `Event ${idx+1}`;
      nameInput.addEventListener("change", () => {
        const v = nameInput.value.trim();
        ev.name = v || `Event ${idx+1}`;
        nameInput.value = ev.name;
      });

      const del = document.createElement("button");
      del.className = "removeBtn";
      del.textContent = "Remove";
      del.disabled = events.length === 1;
      del.title = del.disabled ? "Keep at least one event" : "Remove this event";
      del.addEventListener("click", () => {
        if (events.length === 1) return;
        events = events.filter(x => x !== ev);
        events.forEach((e, i) => {
          if (/^Event\s+\d+$/i.test(e.name || "")) e.name = `Event ${i+1}`;
        });
        render();
      });

      header.appendChild(nameInput);
      header.appendChild(del);
      card.appendChild(header);

      STAGES.forEach(st => {
        const row = document.createElement("div");
        row.className = "stageRow";

        const label = document.createElement("div");
        label.className = "stageLabel";
        label.textContent = st.label;

        row.appendChild(label);
        row.appendChild(makeTimeCell(ev, st.key));
        card.appendChild(row);
      });

      container.appendChild(card);
    });

    $("status").textContent = "";
  }

  function validateRange(t){
    return t.h >= 0 && t.h <= 23 && t.m >= 0 && t.m <= 59 && t.s >= 0 && t.s <= 59;
  }

  function calculate() {
    const midnightHandling = $("midnight").checked;

    const ttds = [];
    const ttrs = [];
    const errors = [];
    const lines = [];

    events.forEach((ev, idx) => {
      const name = (ev.name || `Event ${idx+1}`).trim() || `Event ${idx+1}`;
      const c = ev.t.created, d = ev.t.detected, r = ev.t.response;

      if (!validateRange(c) || !validateRange(d) || !validateRange(r)) {
        errors.push(`${name}: invalid time (HH 0–23, MM/SS 0–59)`);
        lines.push(`${name}\n  ERROR: invalid time (HH 0–23, MM/SS 0–59)\n`);
        return;
      }

      const allEmpty = isAllZero(c) && isAllZero(d) && isAllZero(r);
      if (allEmpty) {
        errors.push(`${name}: missing times`);
        lines.push(`${name}\n  ERROR: missing times\n`);
        return;
      }
      if (isAllZero(c) || isAllZero(d) || isAllZero(r)) {
        errors.push(`${name}: missing one or more times`);
        lines.push(`${name}\n  ERROR: missing one or more times\n`);
        return;
      }

      const createdSec  = hmsToSec(c.h, c.m, c.s);
      const detectedSec = hmsToSec(d.h, d.m, d.s);
      const responseSec = hmsToSec(r.h, r.m, r.s);

      const ttd = diffClockSeconds(createdSec, detectedSec, midnightHandling);
      const ttr = diffClockSeconds(detectedSec, responseSec, midnightHandling);

      if (!Number.isFinite(ttd) || !Number.isFinite(ttr)) {
        errors.push(`${name}: times out of order (try Midnight rollover)`);
        lines.push(`${name}\n  ERROR: times out of order (try Midnight rollover)\n`);
        return;
      }

      ttds.push(ttd);
      ttrs.push(ttr);

      lines.push(
`${name}
  TTD: ${formatHMS(ttd)}
  TTR: ${formatHMS(ttr)}
`
      );
    });

    const valid = ttds.length;
    const invalid = errors.length;
    const totalRows = events.length;

    const showMeans = valid >= 2;
    const labelTTD = showMeans ? "MTTD" : "TTD";
    const labelTTR = showMeans ? "MTTR" : "TTR";

    const valueTTD = showMeans ? mean(ttds) : (valid === 1 ? ttds[0] : null);
    const valueTTR = showMeans ? mean(ttrs) : (valid === 1 ? ttrs[0] : null);

    const summary = $("summary");
    summary.innerHTML = "";

    const cards = [
      { k: labelTTD, v: valueTTD == null ? "—" : formatHMS(valueTTD), h: showMeans ? "Mean (Created → Detected)" : "Created → Detected" },
      { k: labelTTR, v: valueTTR == null ? "—" : formatHMS(valueTTR), h: showMeans ? "Mean (Detected → Response)" : "Detected → Response" },
      { k: "Rows", v: `${valid} valid / ${totalRows} total`, h: invalid ? `${invalid} invalid (ignored)` : "All good" },
    ];

    for (const c of cards) {
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `<div class="k">${c.k}</div><div class="v">${c.v}</div><div class="h">${c.h}</div>`;
      summary.appendChild(el);
    }

    $("summarySub").textContent =
      valid === 1 ? "Single event" :
      valid >= 2 ? "Multiple events" :
      "No valid events";

    $("status").innerHTML = invalid
      ? `<span class="bad">${invalid} invalid</span> · <span class="ok">${valid} valid</span>`
      : (valid ? `<span class="ok">All valid</span>` : `<span class="bad">No valid</span>`);

    const out = $("output");
    out.classList.remove("outEmpty");
    out.textContent =
      lines.join("\n") +
      (errors.length ? ("\nInvalid rows:\n- " + errors.join("\n- ")) : "");
  }

  async function copyResults() {
    const text = $("output").textContent || "";
    if (!text.trim() || text.includes("Run Calculate")) {
      toast("Nothing to copy yet.");
      return;
    }
    try {
      await navigator.clipboard.writeText(text);
      toast("Copied.");
    } catch {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      toast("Copied.");
    }
  }

  function clearAll() {
    events = [ newEvent("Event 1") ];
    $("summary").innerHTML = "";
    $("summarySub").textContent = "Run Calculate";
    $("status").textContent = "";
    const out = $("output");
    out.textContent = "Run Calculate to see results.";
    out.classList.add("outEmpty");
    render();
    toast("Cleared.");
  }

  $("addRow").addEventListener("click", () => {
    const n = events.length + 1;
    events.push(newEvent(`Event ${n}`));
    render();
  });

  $("calc").addEventListener("click", calculate);
  $("copy").addEventListener("click", copyResults);
  $("clear").addEventListener("click", clearAll);

  render();
})();
</script>
</body>
</html>